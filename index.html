<!DOCTYPE html>
<html>
<head>
  <title>Tabel Penghasilan Sawit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; padding: 20px; }
    h2 { text-align: center; margin-bottom: 20px; font-size: 20px; }
    table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #4CAF50; color: white; position: sticky; top: 0; z-index: 2; }
    tfoot td { font-weight: bold; background: #f9f9f9; }
    input { width: 70px; text-align: right; padding: 4px; }
    .btn-container { text-align: center; margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
    button, a.whatsapp-btn { margin: 5px; padding: 6px 10px; border: none; border-radius: 5px; background: #4CAF50; color: white; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; font-size: 12px; }
    button:hover, a.whatsapp-btn:hover { background: #45a049; }
    .note { font-size: 7px; color: #777; margin-bottom: 8px; font-style: italic; width: 100%; text-align: center; }
    @media screen and (max-width: 768px) { h2 { font-size: 16px; } table { font-size: 12px; } input { width: 50px; font-size: 12px; } th, td { padding: 4px; } .btn-container { flex-direction: column; align-items: center; } button, a.whatsapp-btn { width: 100%; max-width: 250px; } }
    @media screen and (min-width: 1024px) { h2 { font-size: 24px; } table { font-size: 15px; } input { width: 80px; } }
  </style>
</head>
<body>
<h2>Tabel Penghasilan Bulan Agustus 2025</h2>
<div style="overflow-x:auto;">
  <table id="tabelSawit">
    <thead>
      <tr id="headerRow">
        <th>Tanggal</th>
        <th>Asroful</th>
        <th>Jumahir</th>
        <th>Rahim</th>
        <th>Kamran</th>
        <th>Hartono</th>
        <th>Selamet</th>
        <th>Dhali</th>
        <th>Zul azmi</th>
        <th>Pojol</th>
        <th>Rosid</th>
        <th>Total/Hari</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
    <tfoot>
      <tr id="footerRow">
        <td>Total/Orang</td>
        <td class="colTotal"></td>
        <td class="colTotal"></td>
        <td class="colTotal"></td>
        <td class="colTotal"></td>
        <td class="colTotal"></td>
        <td class="colTotal"></td>
        <td class="colTotal"></td>
        <td class="colTotal"></td>
        <td class="colTotal"></td>
        <td class="colTotal"></td>
        <td id="grandTotal"></td>
      </tr>
    </tfoot>
  </table>
</div>

<div class="btn-container">
  <button onclick="requestSave()">üíæ Simpan Data</button>
  <button onclick="requestDelete()">üóë Hapus Data</button>
  <button onclick="addColumn()">‚ûï Tambah Kolom</button>
  <button onclick="deleteColumn()">‚ûñ Hapus Kolom</button>
  <button onclick="exportTableToExcel()">‚¨áÔ∏è Export ke Excel</button>
  <a class="whatsapp-btn" href="https://wa.me/601141340245" target="_blank">üì≤ Hubungi Admin via WhatsApp</a>
  <div class="note">‚ö†Ô∏è Data hanya tersimpan di browser, refresh akan tetap menyimpan jika sudah klik Simpan.</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const ADMIN_CODE = "opunkGX";
const tableBody = document.getElementById("tableBody");
const headerRow = document.getElementById("headerRow");
const footerRow = document.getElementById("footerRow");

// buat 31 baris
for (let i = 1; i <= 31; i++) {
  const row = document.createElement("tr");
  const hariCell = document.createElement("td"); hariCell.textContent = " " + i; row.appendChild(hariCell);

  for (let j = 0; j < 10; j++) {
    const td = document.createElement("td");
    const input = document.createElement("input");
    input.type = "number"; input.step = "any"; input.dataset.row = i; input.dataset.col = j; input.dataset.valueRaw = 0;
    input.oninput = () => { input.dataset.valueRaw = input.value; hitungTotal(); tampilkan2Desimal(input); };
    td.appendChild(input);
    row.appendChild(td);
  }

  const totalCell = document.createElement("td");
  const totalInput = document.createElement("input");
  totalInput.type = "number"; totalInput.step = "any"; totalInput.classList.add("rowTotal"); totalInput.dataset.row = i; totalInput.dataset.valueRaw = 0;
  totalInput.oninput = () => {
    const total = parseFloat(totalInput.value);
    if (isNaN(total)) return;
    const inputs = row.querySelectorAll("td input:not(.rowTotal)");
    const perOrang = total / inputs.length;
    inputs.forEach(inp => { inp.dataset.valueRaw = perOrang; inp.value = perOrang; tampilkan2Desimal(inp); });
    hitungTotal();
  };
  totalCell.appendChild(totalInput);
  row.appendChild(totalCell);

  tableBody.appendChild(row);
}

// format 2 desimal tanpa ubah nilai
function tampilkan2Desimal(input) {
  if (document.activeElement !== input) {
    const val = parseFloat(input.dataset.valueRaw);
    if (!isNaN(val)) input.value = val.toFixed(2);
  }
}

function hitungTotal() {
  const rows = tableBody.querySelectorAll("tr");
  const colCount = headerRow.querySelectorAll("th").length - 2;
  const colTotals = Array(colCount).fill(0);
  let grandTotal = 0;

  rows.forEach(row => {
    const inputs = row.querySelectorAll("td input:not(.rowTotal)");
    let rowTotal = 0;
    inputs.forEach((inp, idx) => {
      const val = parseFloat(inp.dataset.valueRaw);
      if (!isNaN(val)) { colTotals[idx] += val; rowTotal += val; }
      tampilkan2Desimal(inp);
    });
    const totalInput = row.querySelector(".rowTotal");
    if (totalInput && document.activeElement !== totalInput) {
      totalInput.dataset.valueRaw = rowTotal;
      totalInput.value = rowTotal.toFixed(2);
    }
    grandTotal += rowTotal;
  });

  const colTotalCells = footerRow.querySelectorAll(".colTotal");
  colTotalCells.forEach((cell, idx) => {
    cell.textContent = colTotals[idx] ? colTotals[idx].toFixed(2) : "";
  });
  document.getElementById("grandTotal").textContent = grandTotal.toFixed(2);
}

// simpan/load data
function saveData() {
  const data = {};
  document.querySelectorAll("input").forEach(input => {
    const key = `r${input.dataset.row || "x"}c${input.dataset.col || "total"}`;
    data[key] = input.dataset.valueRaw;
  });
  localStorage.setItem("sawitData", JSON.stringify(data));
  alert("‚úÖ Data berhasil disimpan!");
}
function loadData() {
  const saved = localStorage.getItem("sawitData");
  if (saved) {
    const data = JSON.parse(saved);
    document.querySelectorAll("input").forEach(input => {
      const key = `r${input.dataset.row || "x"}c${input.dataset.col || "total"}`;
      if (data[key] !== undefined) input.dataset.valueRaw = data[key];
    });
    hitungTotal();
  }
}
function requestSave() {
  const kode = prompt("Masukkan kode admin untuk simpan data:");
  if (kode === ADMIN_CODE) saveData();
  else if (kode) alert("‚ùå Kode salah!");
}
function requestDelete() {
  const kode = prompt("Masukkan kode admin untuk hapus data:");
  if (kode === ADMIN_CODE) {
    if (confirm("Yakin hapus semua data?")) {
      localStorage.removeItem("sawitData");
      document.querySelectorAll("input").forEach(input => input.dataset.valueRaw = 0);
      hitungTotal();
      alert("üóë Semua data telah dihapus!");
    }
  } else if(kode) alert("‚ùå Kode salah!");
}

// tambah/hapus kolom
function addColumn() {
  const name = prompt("Masukkan nama kolom baru:");
  if(!name) return alert("‚ùå Nama kolom tidak boleh kosong.");
  const th = document.createElement("th"); th.textContent = name;
  headerRow.insertBefore(th, headerRow.lastElementChild);

  const tdNew = document.createElement("td"); tdNew.classList.add("colTotal");
  footerRow.insertBefore(tdNew, footerRow.lastElementChild);

  const rows = tableBody.querySelectorAll("tr");
  rows.forEach((row, idx) => {
    const td = document.createElement("td");
    const input = document.createElement("input"); 
    input.type="number"; input.step="any"; 
    input.dataset.row=idx+1; 
    input.dataset.col=headerRow.querySelectorAll("th").length-2;
    input.dataset.valueRaw = 0;
    input.oninput = () => { input.dataset.valueRaw = input.value; hitungTotal(); tampilkan2Desimal(input); };
    td.appendChild(input);
    row.insertBefore(td, row.lastElementChild);
  });
  alert("‚úÖ Kolom '" + name + "' berhasil ditambahkan!");
  hitungTotal();
}
function deleteColumn() {
  const ths = headerRow.querySelectorAll("th");
  if(ths.length <= 2) return alert("‚ùå Tidak bisa hapus kolom tersisa!");
  const colIdx = ths.length - 2;

  headerRow.removeChild(ths[colIdx]);
  footerRow.removeChild(footerRow.querySelectorAll("td")[colIdx]);
  tableBody.querySelectorAll("tr").forEach(row => row.removeChild(row.querySelectorAll("td")[colIdx]));
  alert("üóë Kolom terakhir berhasil dihapus!");
  hitungTotal();
}

// export ke excel
function exportTableToExcel() {
  const wb = XLSX.utils.table_to_book(document.getElementById("tabelSawit"), {sheet:"Sheet1"});
  XLSX.writeFile(wb, "Tabel_Penghasilan_Sawit.xlsx");
}

window.onload = loadData;
</script>
</body>
</html>
